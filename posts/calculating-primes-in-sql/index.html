<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#E8888A}</style><title>Calculating Prime Numbers in SQL</title><meta name=description content="Implementing the Sieve of Eratosthenes in SQL using Recursive Expressions"><meta name=keywords content="blog,gokarna,hugo,sql,math,interview"><meta property="og:url" content="https://filipre.github.io/posts/calculating-primes-in-sql/"><meta property="og:type" content="website"><meta property="og:title" content="Calculating Prime Numbers in SQL"><meta property="og:description" content="Implementing the Sieve of Eratosthenes in SQL using Recursive Expressions"><meta property="og:image" content="https://filipre.github.io/images/avatar.png"><meta property="og:image:secure_url" content="https://filipre.github.io/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Calculating Prime Numbers in SQL"><meta name=twitter:description content="Implementing the Sieve of Eratosthenes in SQL using Recursive Expressions"><meta property="twitter:domain" content="https://filipre.github.io/posts/calculating-primes-in-sql/"><meta property="twitter:url" content="https://filipre.github.io/posts/calculating-primes-in-sql/"><meta name=twitter:image content="https://filipre.github.io/images/avatar.png"><link rel=canonical href=https://filipre.github.io/posts/calculating-primes-in-sql/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://filipre.github.io/><img src=/images/avatar.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://filipre.github.io/>René's Blog</a></div><div class=nav-links><div class=nav-link><a href=https://filipre.github.io/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://filipre.github.io/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://filipre.github.io/contact><span data-feather=mail></span> Contact</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://filipre.github.io/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://filipre.github.io/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://filipre.github.io/contact><span data-feather=mail></span> Contact</a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Calculating Prime Numbers in SQL</h1><small role=doc-subtitle>Implementing the Sieve of Eratosthenes in SQL using Recursive Expressions</small><p class=post-date>28 January, 2024</p><ul class=post-tags><li class=post-tag><a href=https://filipre.github.io/tags/sql>sql</a></li><li class=post-tag><a href=https://filipre.github.io/tags/math>math</a></li><li class=post-tag><a href=https://filipre.github.io/tags/interview>interview</a></li></ul></div><div class=post-content><p><p>Ever needed to calculate prime numbers in a SQL database? No? Here is the query anyways:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> <span style=color:#66d9ef>recursive</span> primes(i, d) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> generate_series(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>10000</span>), <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>union</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> i, (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>min</span>(i) <span style=color:#66d9ef>from</span> primes <span style=color:#66d9ef>where</span> i <span style=color:#f92672>&gt;</span> d)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> primes
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>where</span> d <span style=color:#f92672>&lt;=</span> (<span style=color:#66d9ef>select</span> sqrt(<span style=color:#66d9ef>max</span>(i)) <span style=color:#66d9ef>from</span> primes) <span style=color:#66d9ef>and</span> (i <span style=color:#f92672>&lt;=</span> d <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>mod</span>(i, d) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> i
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> primes
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> d <span style=color:#f92672>=</span> (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>max</span>(d) <span style=color:#66d9ef>from</span> primes)
</span></span><span style=display:flex><span><span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> primes.i <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div><p>You can try it out <a href=https://hyper-db.de/interface.html>here</a>. To confirm it, there are <a href=https://jalu.ch/coding/primes/list.php>1229</a> primes between 2 and 10000. If you want to know how the query works, read on!</p><h2 id=introduction>Introduction</h2><p>Many SQL databases offer an advanced functionality called &ldquo;Recursive SQL Expressions&rdquo;. It allows you to query hierarchical data sets such as a family tree (&ldquo;List all ancestors of a given person&rdquo;) or a movie-actor database (&ldquo;What <a href=https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon>Bacon</a> number does an actor have?&rdquo;). It turns out, a more silly use case is to calculate prime numbers using the <a href=https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes>Sieve of Eratosthenes</a>. Let&rsquo;s start with the basics:</p><p><em>Definition:</em> A natural number is prime if it has exactly two positive divisors. The set can be written as</p><p>$$
\mathbb{P} = \lbrace n \in \mathbb{N} \ | \ d(n) = 2 \rbrace
$$</p><p>where $d(n)$ counts the number of divisors.</p><p>There are different ways to generate primes but one very straight forward way is the Sieve of Eratosthenes. The idea is to list all numbers from $2$ to $n$ and then crossing out numbers that are multiple of $2$, $3$, $5$, etc. until you reach $n$ (or rather $\sqrt{n}$). Everything that is left over will be prime. Implementing the sieve is a very common programming exercise when learning programming or during <a href=https://leetcode.com/problems/count-primes/description/>interviews</a>.</p><h2 id=recursive-sql>Recursive SQL</h2><p><a href=https://builtin.com/data-science/recursive-sql>This</a> article explains Recurisve SQL quite well. You start with an initial table $r_0$ (base case) and apply a query that modifies it somehow to get the partial result table $r_1$. When the new table isn&rsquo;t empty, you take $r_1$ as an input and generate $r_2$, and so on until the result becomes empty. The final result is then the union of all partial results $r = r_0 \cup r_1 \cup \dotsb \cup r_n$.</p><p>For example, consider the following recursive expression that will calculate powers of $2$ smaller than $100$.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> <span style=color:#66d9ef>recursive</span> power2(i) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#75715e>-- base case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>select</span> <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>union</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>-- recursion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>select</span> i<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>from</span> power2 <span style=color:#66d9ef>where</span> i<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> i <span style=color:#66d9ef>from</span> power2 <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> i <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div><p>It starts with $r_0 = 1$ and then doubles the previous result as long as the result is smaller than $100$. This is the stoping condition that prevents an inifinite loop of the query.</p><h2 id=naive-implementation-of-the-sieve-of-eratosthenes>Naive Implementation of the Sieve of Eratosthenes</h2><p>Let&rsquo;s start with a simple implementation to explain the main idea. Let the column $i$ be an initial sequence from $2$ to $n$ and let the column $d$ be initially set to $2$. For every iteration, we take the last divisor $d$ and filter all numbers from $i$ that are divisible by $d$ (<code>mod(i, d) != 0</code>), except when $d$ divides itself (<code>i &lt;= d</code>). Then we increase $d$ by one. All numbers that are left in the end will be prime numbers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> <span style=color:#66d9ef>recursive</span> primes(i, d) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> generate_series(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>10000</span>), <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>union</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> i, d <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> primes
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>where</span> d <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10000</span> <span style=color:#66d9ef>and</span> (i <span style=color:#f92672>&lt;=</span> d <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>mod</span>(i, d) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> i
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> primes
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> d <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> primes.i <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div><p>Here is some visualization from iteration 0 to 1</p><table><thead><tr><th>$i_0$</th><th>$d_0$</th><th>→</th><th>$i_1$</th><th>$d_1$</th><th>Comment</th></tr></thead><tbody><tr><td>2</td><td>2</td><td>→</td><td>2</td><td>3</td><td>2 is smaller/equal to 2</td></tr><tr><td>3</td><td>2</td><td>→</td><td>3</td><td>3</td><td>2 doesn&rsquo;t divide 3</td></tr><tr><td>4</td><td>2</td><td></td><td></td><td></td><td>2 divides 4</td></tr><tr><td>5</td><td>2</td><td>→</td><td>5</td><td>3</td><td>2 doesn&rsquo;t divide 5</td></tr><tr><td>6</td><td>2</td><td></td><td></td><td></td><td>2 divides 6</td></tr><tr><td></td><td></td><td>$\ldots$</td><td></td><td></td><td>$\ldots$</td></tr><tr><td>9999</td><td>2</td><td>→</td><td>9999</td><td>3</td><td>2 doesn&rsquo;t divide 9999</td></tr><tr><td>10000</td><td>2</td><td></td><td></td><td></td><td>2 divides 10000</td></tr></tbody></table><p>and from iteration 1 to 2</p><table><thead><tr><th>$i_1$</th><th>$d_1$</th><th>→</th><th>$i_2$</th><th>$d_2$</th><th>Comment</th></tr></thead><tbody><tr><td>2</td><td>3</td><td>→</td><td>2</td><td>4</td><td>2 is smaller/equal to 3</td></tr><tr><td>3</td><td>3</td><td>→</td><td>3</td><td>4</td><td>3 is smaller/equal to 3</td></tr><tr><td>5</td><td>3</td><td>→</td><td>5</td><td>4</td><td>4 doesn&rsquo;t divide 5</td></tr><tr><td></td><td></td><td>$\ldots$</td><td></td><td></td><td>$\ldots$</td></tr><tr><td>9999</td><td>3</td><td></td><td></td><td></td><td>3 divides 9999</td></tr></tbody></table><h2 id=optimization>Optimization</h2><p>We can optimize the query a bit. Instead of testing every number from $d = 2$ to $d = 10000$, we only have to test numbers that were not multiples of previous divisors. For example, there is no need to check for $d = 4$ because $d = 2$ filters all multples of $4$ already. We can replace the term <code>d + 1</code> with <code>select min(i) from primes where i > d</code>. This already reduces 90 % of iterations in our case.</p><p>Another optimization is to let $d$ only run up to $\sqrt{n}$ and not $n$. Our sieve is essentially checking if a number is a factor of another number. Suppose all factors of a number $i$ are greater than $\sqrt{n}$. That means, that $i$ must be then greater than $n$ but we are only interested in numbers up to $n$.</p><p>This yields the final query which takes 7 ms on <a href=https://hyper-db.de/interface.html>HyPer DB</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>with</span> <span style=color:#66d9ef>recursive</span> primes(i, d) <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> generate_series(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>10000</span>), <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>union</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>select</span> i, (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>min</span>(i) <span style=color:#66d9ef>from</span> primes <span style=color:#66d9ef>where</span> i <span style=color:#f92672>&gt;</span> d)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>from</span> primes
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>where</span> d <span style=color:#f92672>&lt;=</span> (<span style=color:#66d9ef>select</span> sqrt(<span style=color:#66d9ef>max</span>(i)) <span style=color:#66d9ef>from</span> primes) <span style=color:#66d9ef>and</span> (i <span style=color:#f92672>&lt;=</span> d <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>mod</span>(i, d) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> i
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> primes
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> d <span style=color:#f92672>=</span> (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>max</span>(d) <span style=color:#66d9ef>from</span> primes)
</span></span><span style=display:flex><span><span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> primes.i <span style=color:#66d9ef>ASC</span>
</span></span></code></pre></div></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div></main><footer class=footer><span>&copy; 2024 René Filip</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>